#!/system/bin/mksh

echo ()
{
echo "$1" | fold -s -w 45
}
/system/bin/id |grep root > /dev/null 2>&1
if [ $? -ne 0 ]
 then
 echo "batt-cfg must be ran as root."
 echo "Press enter to attempt to run as root"
 echo "Or press 1 then enter to continue without attempting to gain root access"
 echo ""
 read opt
 if [ "$opt" -eq "1" ] 
  then
	echo "Continuing..."
 else
 su -c "batt-cfg"
 echo "Exited batt-cfg as root"
 exit
 fi
fi

show_available_schedulers()
{
echo "Available schedulers"
cat /sys/block/mmcblk0/queue/scheduler
echo ""
}

show_available_governors()
{
echo "Available Governors:"
cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_available_governors
echo ""
}

show_freq_table()
{
echo "Available Frequencies:"
awk < /sys/devices/system/cpu/cpu0/cpufreq/stats/time_in_state '{ print $1 " " }' | awk -v RS="\n" -v ORS="" {print} | fold -s -w 40 
echo ""
}

#Added USBpower definitions and options by Decad3nce

#this may seem redundant because they are included in load_defaults
#this is only here in case the person upgraded from a prior version
#sets sensible defaults in that case
MaxTempEnable=n
enabled=1
#end of sensible upgrade defaults
. /system/etc/batt.conf

toggle()
{
if [ "$1" -gt "0" ]
   then
	 echo 0
	 else
 	 echo 1
fi
}

get_disp()
{
if [ "$1" -gt "0" ]
   then
	 echo "Disable"
	 else
	 echo "Enable"
fi
}

load_defaults()
{
MaxTempEnable=n
MaxTemp=450
MaxFreqOverride=800000
MinFreqOverride=200000
enabled=1
cpu_max_underclock_perc=58
cpu_limiting_method=1
max_freq_on_battery=1000000
max_freq_on_USBpower=1000000
polling_interval_on_battery=75
polling_interval_on_USBpower=15
polling_interval_on_power=15
min_freq_on_battery=200000
min_freq_on_power=200000
min_freq_on_USBpower=200000
}

TempManagement()
{
echo ""
echo ""
echo ""

echo "Overclocking, tethering, and high usage can lead to overheating which may damage your battery in the long run. Adjusting the Max Temperature for which to cause a max frequency override will ensure the safety of your battery. Would you like to activate it? [y/n] [$MaxTempEnable]."
read new_MaxTempEnable
echo ""
case $new_MaxTempEnable in
           "y") MaxTempEnable=y;;
           "n") MaxTempEnable=n;;
             *) echo "Settings unchanged";;
esac

echo "Please set the desired max temperature at which you will allow your devices battery to run at or leave it unchanged. This value is the temperature in Celsius * 10 [$MaxTemp]"
echo "To give you an idea, your current temprature is:"
cat /sys/class/power_supply/battery/temp
echo "In Celcius:"
temptmp=`cat /sys/class/power_supply/battery/temp`
cel=`expr "$temptmp" "/" 10`
echo $cel
echo ""
read new_MaxTemp
echo ""
tmaxtemp=$MaxTemp
if [ "$new_MaxTemp" ] 
   then
	tmaxtemp=$new_MaxTemp
	MaxTemp=$tmaxtemp	 
fi

show_freq_table
echo "Now please set the desired minimum frequency for which to override when you start to overheat to or leave unchanged [$MinFreqOverride]"
read new_MinFreqOverride
echo ""
echo "Now please set the desired maximumfrequency for which to override when you start to overheat to or leave unchanged [$MaxFreqOverride]"
read new_MaxFreqOverride
echo ""

tminfreq=$MinFreqOverride
if [ "$new_MinFreqOverride" ]
   then
	tminfreq=$new_MinFreqOverride
fi

tmaxfreq=$MaxFreqOverride
if [ "$new_MaxFreqOverride" ]
   then
	tmaxfreq=$new_MaxFreqOverride
fi

if [ $tmaxfreq -ge $tminfreq ]
   then
	 MinFreqOverride=$tminfreq
	 MaxFreqOverride=$tmaxfreq
	 echo "Override CPU settings accepted."
	 else
	 echo "Invalid Override CPU Settings. New Override CPU settings ignored."
fi
}

restart()
{
echo "Starting batt.sh"
#nohup /system/bin/batt.sh 2>/dev/null &
start collin_ph
t=`pidof batt.sh`
if [ "$t" ]
   then
	 echo "Started"
   else
	 nohup /system/bin/batt.sh 2>/dev/null &
	 echo "NOTE: when you exit ADB or terminal, you may have to hit CTRL-C"
fi

}
customize()
{
echo ""
echo ""
echo ""

echo "You will be asked a series of configuration questions. After Each option, enter your selection and press enter. Leave blank and press enter to keep the current setting."
echo ""

echo "The CPU limiting method is either underclock or powersave bias. Underclock reclocks the cpu to a lower speed to conserve battery. Powersave bias limits individual processes CPU usage to conserve battery."
echo "";

echo "[1] Underclock (highly recommended)"
echo "[2] Powersave Bias"
echo "Make a choice and hit enter, or leave blank to leave unchanged [$cpu_limiting_method]"
read new_cpu_limiting_method
echo ""
case $new_cpu_limiting_method in
        "1") cpu_limiting_method=1;;
        "2") cpu_limiting_method=2;;
				*) echo "setting unchanged";;
esac

echo ""
echo ""
echo ""
echo ""
echo ""
echo ""
echo ""
echo "The cpu scaling governor controls how/when your cpu scales on the frequency table"
echo "";

show_available_governors
echo "Make a choice and hit enter, or leave blank to leave unchanged [$scaling_governor]"
read new_scaling_governor
echo ""
tscale=$scaling_governor
if [ "$new_scaling_governor" ] 
   then 
   tscale=$new_scaling_governor
fi
scaling_governor=$tscale

echo ""
echo ""
echo ""
echo ""
echo ""
echo ""
echo ""
echo "The cpu scheduler controls how the system tasks are scheduled"
echo "";

show_available_schedulers
echo "Make a choice and hit enter, or leave blank to leave unchanged [$cpu_scheduler]"
read new_cpu_scheduler
echo ""
tsched=$cpu_scheduler
if [ "$new_cpu_scheduler" ] 
   then 
   tsched=$new_cpu_scheduler
fi
cpu_scheduler=$tsched

echo ""
echo ""
echo ""
echo ""
echo ""
echo ""
echo ""
echo "The Min and Max frequency settings determine how fast the CPU runs. The Min frequency must be less than or equal to the Max."
echo "Some phones do not support settings higher than 1000000 (1GHz)."
echo ""
show_freq_table

echo ""
echo "Choose a Min CPU setting while ON BATTERY or enter [$min_freq_on_battery]"
read new_min_freq_on_battery
echo ""
echo "Choose a Max CPU setting while ON BATTERY or enter [$max_freq_on_battery]"
read new_max_freq_on_battery
echo ""
tminf=$min_freq_on_battery
if [ "$new_min_freq_on_battery" ] 
   then 
   tminf=$new_min_freq_on_battery
fi
tmaxf=$max_freq_on_battery
if [ "$new_max_freq_on_battery" ]
   then
	 tmaxf=$new_max_freq_on_battery
fi

if [ $tmaxf -ge $tminf ]
   then
	 min_freq_on_battery=$tminf
	 max_freq_on_battery=$tmaxf
	 echo "Battery CPU settings accepted."
	 else
	 echo "Invalid Battery CPU Settings. New Battery CPU settings ignored."
fi

echo ""
echo ""
echo ""
echo ""
echo "The Min and Max frequency settings determine how fast the CPU runs. Some phones do not support settings higher than 1000000 (1GHz)."
echo ""
show_freq_table
echo ""
echo "Choose a Min CPU setting while ON USB POWER or enter [$min_freq_on_USBpower]"
read new_min_freq_on_USBpower
echo ""
echo "Choose a Max CPU setting while ON USB POWER or enter [$max_freq_on_USBpower]"
read new_max_freq_on_USBpower
echo ""
tminf=$min_freq_on_USBpower
if [ "$new_min_freq_on_USBpower" ] 
   then 
   tminf=$new_min_freq_on_USBpower
fi
tmaxf=$max_freq_on_USBpower
if [ "$new_max_freq_on_USBpower" ]
   then
	 tmaxf=$new_max_freq_on_USBpower
fi

if [ "$tmaxf" -ge "$tminf" ]
   then
	 min_freq_on_USBpower=$tminf
	 max_freq_on_USBpower=$tmaxf
	 echo "USB Power CPU settings accepted."
	 else
	 echo "Invalid USB Power CPU Settings. New USB Power CPU settings ignored."
fi

echo ""
echo ""
echo ""
echo ""
echo ""
echo ""
echo ""
echo ""

echo "Set CPU settings on AC POWER. Note: These settings differ from USB charging."
echo ""
show_freq_table
echo "Choose a Min CPU setting while ON AC POWER or enter [$min_freq_on_power]"
read new_min_freq_on_power
echo ""
echo "Choose a Max CPU setting while ON AC POWER or enter [$max_freq_on_power]"
read new_max_freq_on_power
echo ""

tminf=$min_freq_on_power
if [ "$new_min_freq_on_power" ] 
   then 
   tminf=$new_min_freq_on_power
fi
tmaxf=$max_freq_on_power
if [ "$new_max_freq_on_power" ]
   then
	 tmaxf=$new_max_freq_on_power
fi

if [ "$tmaxf" -ge "$tminf" ]
   then
	 min_freq_on_power=$tminf
	 max_freq_on_power=$tmaxf
	 echo "Power CPU settings accepted."
	 else
	 echo "Invalid AC Power CPU Settings. New Power CPU settings ignored."
fi

echo ""
echo ""
echo ""
echo ""
echo ""
echo ""
echo ""
echo ""

echo "The batt.sh service will poll the system perodically to detect the power state. The delay between polls (in seconds) is called the polling interval. To save battery, this interval should be longer when on battery. When on AC power, the interval is less. This helps quickly adjust the settings when the power is removed. The lower the intervals, the more CPU will be used."

echo "Enter the polling interval (in seconds) when on battery: [$polling_interval_on_battery]"
read new_polling_interval_on_battery
echo ""
if [ "$new_polling_interval_on_battery" -gt 1 ] 
   then
	 polling_interval_on_battery=$new_polling_interval_on_battery
else
   echo "Interval not updated"
fi

echo "Enter the polling interval (in seconds) when on USB power: [$polling_interval_on_USBpower]"
read new_polling_interval_on_USBpower
echo ""
if [ "$new_polling_interval_on_battery" -gt 1 ] 
   then
	 polling_interval_on_USBpower=$new_polling_interval_on_USBpower
else
   echo "Interval not updated"
fi

echo "Enter the polling interval (in seconds) when on AC power: [$polling_interval_on_power]"
read new_polling_interval_on_power
echo ""
if [ "$new_polling_interval_on_battery" -gt 1 ] 
   then
	 polling_interval_on_power=$new_polling_interval_on_power
else
   echo "Interval not updated"
fi



echo ""
echo ""
echo ""
echo ""
echo ""
echo ""
echo ""
echo ""
echo "The CPU or process speed will be limited as the battery drains.When fully charged or charging, the CPU will operate at full speed. When nearly dead, the cpu will be reduced by a certain percentage. This percentage must be a whole number and not contain a % sign."
echo ""
echo "Please enter the maximum percentage to reduce the CPU by [$cpu_max_underclock_perc]"
read new_cpu_max_underclock_perc
t=`expr "$new_cpu_max_underclock_perc" ">" 1`
if [ "$t" -gt 0 ] 
   then
	 cpu_max_underclock_perc=$new_cpu_max_underclock_perc  
else
   echo "CPU Underclock percentage not updated."
fi
echo ""

save_settings
}

load_800()
{
echo "Loading 800mhz defaults"
load_defaults
max_freq_on_power=810000
max_freq_on_USBpower=810000
save_settings
}

load_1000()
{
echo "Loading 1000mhz defaults"
load_defaults
max_freq_on_power=1026000
max_freq_on_USBpower=1026000
save_settings
}

load_1350()
{
echo "Loading 1350mhz defaults"
load_defaults
max_freq_on_power=1350000
max_freq_on_USBpower=1350000
save_settings
}

load_1500()
{
echo "Loading 1500mhz defaults"
load_defaults
max_freq_on_power=1512000
max_freq_on_USBpower=1512000
save_settings
}

save_settings()
{
tpid=`pidof batt.sh`
if [ "$tpid" -gt 0 ]
 then
 echo "Killing batt.sh process"
 kill -9 $tpid
 fi

echo "Saving Settings..."
mount -o remount,rw /system /system
echo "enabled=$enabled" > /system/etc/batt.conf
echo "MaxTemp=$MaxTemp" >> /system/etc/batt.conf
echo "MaxTempEnable=$MaxTempEnable" >> /system/etc/batt.conf
echo "MaxFreqOverride=$MaxFreqOverride" >> /system/etc/batt.conf
echo "MinFreqOverride=$MinFreqOverride" >> /system/etc/batt.conf
echo "cpu_limiting_method=$cpu_limiting_method" >> /system/etc/batt.conf
echo "min_freq_on_battery=$min_freq_on_battery" >> /system/etc/batt.conf
echo "max_freq_on_battery=$max_freq_on_battery" >> /system/etc/batt.conf
echo "min_freq_on_USBpower=$min_freq_on_USBpower" >> /system/etc/batt.conf
echo "max_freq_on_USBpower=$max_freq_on_USBpower" >> /system/etc/batt.conf
echo "min_freq_on_power=$min_freq_on_power" >> /system/etc/batt.conf
echo "max_freq_on_power=$max_freq_on_power" >> /system/etc/batt.conf
echo "polling_interval_on_battery=$polling_interval_on_battery" >> /system/etc/batt.conf
echo "polling_interval_on_power=$polling_interval_on_power" >> /system/etc/batt.conf
echo "polling_interval_on_USBpower=$polling_interval_on_USBpower" >> /system/etc/batt.conf
echo "cpu_max_underclock_perc=$cpu_max_underclock_perc " >> /system/etc/batt.conf
echo "scaling_governor=$scaling_governor" >> /system/etc/batt.conf
echo "cpu_scheduler=$cpu_scheduler" >> /system/etc/batt.conf
mount -o remount,ro /system /system

echo ""
echo "Settings Saved."
if [ "$enabled" ]
   then
   restart
fi
exit
}

while [ 1 ]
do

echo ""
echo ""
echo ""
echo ""
echo ""
echo ""
echo ""
echo ""
echo ""
echo ""

echo "The batt-cfg utility configures the collin_ph battery tweak. When on USB/AC power, maximum performance settings will be used. When on battery, more conservative settings will be used. As the battery drains, the CPU clock will be lowered. The CPU Scales between min and max settings always. Additional timing and memory settings are adjusted. Options denoted with a * require a custom kernel to overclock"
echo ""
echo ""
echo ""

echo "Please choose an option and press enter."
echo "[1] Revert to 800mhz defaults and exit"
echo "[2] Revert to 1000mhz defaults and exit"
echo "[3] Revert to 1350mhz defaults and exit*"
echo "[4] Revert to 1500mhz defaults and exit*"
echo "[5] Customize settings"
disp=`get_disp $enabled`
echo "[6] $disp Battery Tweak Entirely"
echo "[7] Temperature Management"
echo "[0] Save Changes & Exit"
echo "[Enter]: Exit Without Saving Changes"
read choice
echo ""
echo ""

  case $choice in
        "1") load_800;;
        "2") load_1000;;
        "3") load_1350;;
        "4") load_1500;;
				"5") customize;;
				"6") enabled=`toggle $enabled`;;
				"7") TempManagement;;
				"0") save_settings;;
				*) echo "Exiting. No Changes Saved"
				   exit;; 
     esac
done

